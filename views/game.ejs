<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Mind game</title>
</head>
<body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/public/js/jquery-3.5.1.min.js"></script>

    <script>
        var gameExecuteList = new Array();
        var gameHost = '<%=game.host%>';
        var username = '<%=username%>';
        var socket;
        var game;

        // lobby loop
        var lobbyLoop = setInterval(function(){
            if(gameExecuteList.length > 0) {
                gameExecuteList.shift()();
            }
        }, 200)

        // Start button process
        var btnStartClick = () => {
            gameExecuteList.push(() => {
                socket.emit('gameStart');
            });
        };

        // Start game process
        var socketGameStart = (socketGame) => {
            gameExecuteList.push(() => {
                game = socketGame;
                $("#lobby").css("display", "none");
            });
        };

        // Player join process
        var socketPlayerJoin = (infos) => {
            gameExecuteList.push(() => {
                game = infos.game;
                var $li = $("<li/>");
                $li.attr("data-player-name", infos.data.username);
                $li.html(infos.data.username);

                $("#player-list>ul").append($li);
            });
        };

        // Player leave process
        var socketPlayerLeave = (infos) => {
            gameExecuteList.push(() => {
                game = infos.game;
                $("#player-list>ul").find("[data-player-name=" + infos.data.username + "]").remove();
            });
        };

        // Error process
        var socketError = (data) => {
            gameExecuteList.push(() => {
                clearInterval(lobbyLoop);
                alert(JSON.stringify(data));
                window.location.href = "/";
            });
        }

        $(document).ready(() => {
            socket = io();

            // User events
            window.onbeforeunload = function (e) {
                socket.emit('playerLeave');
            };
            
            // Joinning game
            gameExecuteList.push(() => {
                socket.emit('playerJoin', { gameHost:gameHost, username:username });
            });
            
            // Socket events
            socket.on('err', socketError);
            socket.on('playerJoin', socketPlayerJoin);
            socket.on('playerLeave', socketPlayerLeave);
            socket.on('gameStart', socketGameStart);

            // UI events
            $("#btn-start").click(btnStartClick);
        });


    </script>

    <div id="lobby">
        <div>welcome to the game of <%=game.host %> !</div>
        <div>Waiting for the host to start the game ...</div>
        <% if (username == game.host) { %>
            <div>
                <button id="btn-start">Start Game</button>
            </div>
        <% } %>
        <div>List of players in the game</div>
        <div id="player-list">
            <ul>
                <% var i =1; %>
                <% game.players.forEach((p) => { %>
                    <li data-player-name="<%=p.name %>">
                        <%=p.name %>
                    </li>
                    <% i++; %>
                <% }); %>
            </ul>
        </div>
        
    </div>





</body>